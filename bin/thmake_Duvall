#!/bin/bash
# thmake -- simple script to compile thesis

# viewing option
VIEW_TF=${1:-true}

# make clean, then make (repeatedly)
cd $THESIS_MAIN
if [[ $(pwd) =~ "THESIS/trunk/MAIN" ]]; then
  make clean
  make
  pdflatex main.tex
  pdflatex main.tex
else
  echo "ERROR: Non-\"THESIS/MAIN\" directory."
  exit 5
fi

# update symlink name here and in $HOME, or create one if not found
for DIR in {$HOME,$THESIS_MAIN}; do
  if [ -L $DIR/Duvall-Thesis-Draft_*.pdf ]; then
    OLD_LINKNAME=$(basename $(ls -tr1 $DIR/Duvall-Thesis-Draft_*.pdf | tail -1))
  fi
  NEW_LINKNAME="Duvall-Thesis-Draft_$(date +%m-%d-%y).pdf"
  # check whether symlink has already been updated on this date
  if [[ ! $OLD_LINKNAME == $NEW_LINKNAME ]]; then
    # update or create symlink
    if [ -L $DIR/$OLD_LINKNAME ]; then
      mv $DIR/$OLD_LINKNAME $DIR/$NEW_LINKNAME
    else
      ln -sf $(pwd)/main.pdf $DIR/$NEW_LINKNAME
    fi
  fi
done

# check if draft; if not, copy out
if grep -q "\%" <(head -1 main.tex); then
  echo -e "\nREMINDER: Switch 'draft' option off for final build!\n"
else
  cp main.pdf drafts/Duvall_Directionality_Dissertation_2022.pdf
fi

# view (optionally)
if $VIEW_TF; then
  evince main.pdf &
fi

# all pau!   )
exit 0
